<!--
#############################################################
##
## The Carte Blanche Guides
## 3.9 Host Your Email: Setting Up Postfix and Dovecot
## CC-BY-SA 3.0 Jacob Cook 2012
##
## For more information about this project, visit
## http://jcook.cc/proj/cbg or http://github.com/jacook/cbg.
##
#############################################################
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CBG - 3.8 Host Your Email: Setting Up Postfix and Dovecot</title>
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
<h2><a href="index.html#3">Setting Up Your Personal Server</a></h2>
<h1><a href="3-8-mail.html">Host Your Email: Setting Up Postfix and Dovecot</a></h1>
<div>
<table cellspacing="0" border="0px" width="100%">
<tbody>
<tr>
  
<td>&lt;&lt; back</td>
  
<td style="text-align: center;"><a href="index.html">[ table of contents ]</a></td>
  
<td style="text-align: right;">next &gt;&gt;</td>
</tr>
</tbody>
</table>
</div><hr><br>
<p>There are two components to the mail system we are going to build. The first component is <b>postfix</b>. Postfix is what we call a "Mail Transfer Agent" (MTA). An MTA is responsible for transporting email between different destinations. When you open your email application and send an email, that document gets transferred first to your email provider's MTA. The MTA then parses the message for a destination address, looks up its server's location on the Internet, then facilitates the transfer of the message to that server. An MTA also handles incoming email in the same way: your MTA gets contacted with a message from somebody else, then your MTA delivers the message to the Mail Delivery Agent.</p>
<p>The Mail Delivery Agent (MDA) is the second part of the mail system. Our MDA is called <b>dovecot</b>. The MDA handles the storage and organization of your mail once it is received. It may help to think of it as such: your MTA is your postman, going from house to house and delivering the mail; the MDA is your mailbox itself.</p>
<br><h3>3.8.1 - First Steps: Install Postfix</h3>
<p>We will begin with installing our MTA, Postfix.</p>
<code class=reg># sudo apt-get install postfix</code>
<p>Postfix comes with a handy semi-graphical configuration tool, which we will use to start. Run the following:</p>
<code class=reg># sudo dpkg-reconfigure postfix</code>
<p>Fill in the following details, which will match our configuration.
<ol>
<li><b>Mail server configuration type:</b> "Internet Site".</li>
<li><b>System mail name:</b> <i>mydomain.com</i></li>
<li><b>Root and postmaster mail recipient:</b> <i>leave blank</i></li>
<li><b>Other destinations to accept mail for:</b> Add <i>mydomain.com</i> to the beginning of this comma-separated list.</li>
<li><b>Force synchronous updates?:</b> No</li>
<li><b>Local networks:</b> Enter your IP subnet that we picked in the Networking section.</li>
<li><b>Use procmail?:</b> No</li>
<li><b>Mailbox size limit:</b> "0"</li>
<li><b>Local address extension character:</b> Leave as default.</li>
<li><b>Internet protocols to use:</b> all</li>
</ol>
<p>Now we need a place to put all that mail that's sure to arrive. In this example we will use the Maildir format, so run:</p>
<code class=reg>sudo postconf -e 'home_mailbox = Maildir/'</code><br>
<code class=reg>export MAIL=/home/<i>username</i>/Maildir</code><br>
<code class=reg>sudo postfix restart</code>
<p>And with that, we have a simple mail transport system running! Take a moment to pat yourself on the back.</p>
<p>Now we will test what we have just set up. Ensure that postfix is running with <code class=inl>sudo postfix status</code>. If it's not, run <code class=inl>sudo postfix start</code>. Then open up <code class=inl>telnet</code> and open a session to your local SMTP port:</p>
<code class=reg>telnet localhost 25</code>
<p>You'll receive the following output and a prompt if you have successfully connected:</p>
<blockquote class=codeml>Trying 127.0.0.1...<br>
Connected to mail.mydomain.com.<br>
Escape character is '^]'.<br>
220 localhost.localdomain ESMTP Postfix (Ubuntu)</blockquote>
<p>This prompt is a little different from the standard command, as it only understands SMTP commands. But not to worry - enter the following commands line-by-line to send yourself a test message:</p>
<blockquote class=codeml>ehlo localhost<br>
mail from: root@localhost<br>
rcpt to: <i>username</i>@localhost<br>
data<br>
Subject: My Postfix Test<br>
<br>
Test Message 123<br>
This is the body<br>
Goodbye<br>
.<br>
quit</blockquote>
<p>Make sure to put your username in the right spot. Also, that line right above "quit" is indeed just a period. That tells postfix that our test message is complete and ready to be sent.</p>
<p>Now let's see if it worked. Run the <code class=inl>mail</code> command and you should see the subject line of your message. Press 1 and Enter to read it. Postfix is aliiiiiiiiiiiiiive!</p>

<br><h3>3.8.2 - Dovecot: Pick Your Poison</h3>
<p>On Ubuntu Server, there are two flavours of dovecot: <code class=inl>dovecot-imapd</code> and <code class=inl>dovecot-pop3d</code> You can install either or both if you'd like. Though the one you choose will depend on which email protocol you would like to use for remote connections. POP is the older protocol, which operates by downloading all email on a remote server to local folders and organizing them by their type. POP then deletes the original messages from your server, leaving you with the copies and folder organization on your local computer only.</p>
<p>IMAP, on the other hand, is a more robust system and is recommended for those who prefer to have their mail synced to multiple locations (for example, on your laptop and on your mobile phone). IMAP syncs your mailbox's folders between the client and the server. Whenever you move an email between boxes, for example, IMAP will sync those changes to your email server in real time. You should be able to see how this is beneficial to people who use their email on multiple devices: no matter what you read or where you read it, the email's status and location can be synced across all of your devices.</p>
<p>So choose the version(s) of dovecot you would like to install:</p>
<code class=reg># sudo apt-get install dovecot-imapd</code>
<h3>3.8.3 - Dovecot: Configure The Beast</h3>
<p>Your main dovecot configuration file is stored at <code class=inl>/etc/dovecot/dovecot.conf</code>. In more recent versions of the software, this file "includes" other configuration files stored elsewhere, which should be easy enough to find by poking through <code class=inl>dovecot.conf</code>. We will be editing a variety of files to get our mail storage system set up.</p>
<p>Let's start with setting up our Maildir. This is the spot where mail is temporarily stored as dovecot routes it to its proper destination.</p>
<br><h3>3.8.4 - Securing Your Mail System</h3>
<p>Next comes our SASL configuration. Put quite simply, SASL is a way for the gaggle of MTAs on the Internet to deliver mail to each other in a secure and trusted fashion. If you want your emails to be able to reach beyond your own server (and the other way around) with any semblance of security, you will need SASL.</p>
<p>Run the following commands to enable SASL in your postfix configuration:</p>
<blockquote class=codeml>sudo postconf -e 'smtpd_sasl_local_domain ='
sudo postconf -e 'smtpd_sasl_auth_enable = yes'<br>
sudo postconf -e 'smtpd_sasl_security_options = noanonymous'<br>
sudo postconf -e 'broken_sasl_auth_clients = yes'<br>
sudo postconf -e 'smtpd_recipient_restrictions = permit_sasl_authenticated,permit_mynetworks,reject_unauth_destination'<br>
sudo postconf -e 'inet_interfaces = all'</blockquote>
<p>Now let's review what we just did: The first line tells postfix to use SASL. The second tells postfix that we don't want any anonymous users trying to log into our system and send spam: everyone must be properly authenticated using SASL. The third line makes SASL play nice with some legacy clients that don't necessarily call it in the proper way. The fourth line (this one is important!) says that our server will automatically accept mail from servers that are SASL authenticated, OR that are connected to our own network, because we know they can be trusted. Furthermore, it will outright reject any mail sent to it that doesn't belong. For example, if my domain name is example.com, we don't want to receive mail for test.net.</p>
<br><h3>3.8.5 - Further Reading</h3>
<ul>
<li><a href="https://help.ubuntu.com/12.10/serverguide/openssh-server.html">OpenSSH Server - Ubuntu Server (12.10) Official Documentation</a></li>
<li><a href="http://linux.die.net/man/5/sshd_config">ssh_config man page</a></li>
<li><a href="https://help.ubuntu.com/community/VNC">VNC - Community Ubuntu Documentation</a></li>
</ul>
<hr>
<table cellspacing="0" border="0px" width="100%">
<tbody>
<tr>
<td>&lt;&lt; back</td>
<td style="text-align: center;"><a href="index.html">[ table of contents ]</a></td>
<td style="text-align: right;">next &gt;&gt;
<br>
</td>
</tr>
</tbody>
</table>
<br>
<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a>
<br>
<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">OFF THE GRID: the Carte Blanche Guide to Digital Independence</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://jcook.cc/offthegrid" property="cc:attributionName" rel="cc:attributionURL">Jacob Cook</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
</div>
</div>


</body>
</html>
